parameters:
- name: appFolderName
  type: string
- name: msappname
  type: string

steps:
  - powershell: |
        Write-Host "$(Build.SourcesDirectory)\CanvasApps\Schema\${{parameters.appFolderName}}\unpacked\Other"
        $inputpath = (Get-ChildItem -Path "$(Build.SourcesDirectory)\CanvasApps\Schema\${{parameters.appFolderName}}\unpacked\Other" -Include Solution.xml -Recurse -File  -ErrorAction SilentlyContinue)
        Write-Host $inputpath.Name
        $regex = '(?<=<Version>).*?(?=<\/Version>)'
        $version = Select-String -Path $inputpath -Pattern $regex -AllMatches | % { $_.Matches } | % { $_.Value }
        $version = $version.Split(".")[3]
        Write-Output "##vso[task.setvariable variable=projectVersion]$version"
          
  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Src\'
      parameterSearchText: '//Set(glbAppVersion,1);'
      parameterReplaceText: 'Set(glbAppVersion,$(projectVersion));'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'App.fx.yaml'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Src\'
      parameterSearchText: '//Set(glbDebug,false);'
      parameterReplaceText: 'Set(glbDebug,false)'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'App.fx.yaml'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Connections\'
      parameterSearchText: '21aab98a-1b9f-4072-949f-61dbb5c7022e'
      parameterReplaceText: 'e0723811-3798-46f8-b9d3-a9583848f235'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'Connections.json'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\CanvasApps\'
      parameterSearchText: '21aab98a-1b9f-4072-949f-61dbb5c7022e'
      parameterReplaceText: 'e0723811-3798-46f8-b9d3-a9583848f235'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'cp_pocketnotebookazure_5e5ef.meta.xml'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Connections\'
      parameterSearchText: '9048514d-7f47-4fab-b619-0794436626de'
      parameterReplaceText: 'e8c42f10-b7a4-426f-8e21-790c4da4be9b'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'Connections.json'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\CanvasApps\'
      parameterSearchText: '0e3d837c-a328-4823-904f-999f848d1695'
      parameterReplaceText: 'f515b7e1-9199-4153-a754-407f763d95f6'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'cp_pocketnotebookazure_5e5ef.meta.xml'

  - task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Connections\'
      parameterSearchText: '0e3d837c-a328-4823-904f-999f848d1695'
      parameterReplaceText: 'f515b7e1-9199-4153-a754-407f763d95f6'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'Connections.json'

- task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Connections\'
      parameterSearchText: '"storageaccount": "cumbriadev"'
      parameterReplaceText: '"storageaccount": "cumbriasystemteststorage"'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'Connections.json'

- task: ReplaceInFilesTextByText@2
    inputs:
      parameterSearchDirectory: '$(Build.SourcesDirectory)/CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp\Connections\'
      parameterSearchText: '/providers/microsoft.powerapps/apis/shared_pnb-20get-5fec56f3da3c70054e-5fec37e65b69cd854d/connections/80073041d82a4a1ab8e3b6a7e4be32cf'
      parameterReplaceText: '/providers/microsoft.powerapps/apis/shared_pnb-20get-5fdec6a3b977ea337d-5fec37e65b69cd854d/connections/d63d8606b8194c3a9a4f1430c6a3021b'
      parameterTypeOfSearch: 'filesList'
      parameterFilesPattern: 
      parameterFilesList: 'Connections.json'

  - task: DeleteFiles@1
    inputs:
      SourceFolder: $(Build.SourcesDirectory)\CanvasApps\Schema\${{parameters.appFolderName}}\unpacked\CanvasApps\
      Contents: cp_${{parameters.msappname}}_DocumentUri.msapp

  - powershell: |
          $(Build.SourcesDirectory)\CanvasApps\365Tools\Tools\PasOpa\PASopa.exe -pack $(Build.SourcesDirectory)\CanvasApps\Schema\${{parameters.appFolderName}}\unpacked\CanvasApps\cp_${{parameters.msappname}}_DocumentUri.msapp $(Build.SourcesDirectory)\CanvasApps\Schema\${{parameters.appFolderName}}\unpackedapp 