parameters:
- name: WebResourcesSolutionName
  type: string
  default: WebResources
- name: OptionSetsSolutionName
  type: string
  default: OptionSets
- name: EntitiesSolutionName
  type: string
  default: Entities
- name: SecurityRolesSolutionName
  type: string
  default: SecurityRoles
- name: ProcessesSolutionName
  type: string
  default: Processes
- name: PluginsSolutionName
  type: string
  default: Plugins
- name: PluginStepsSolutionName
  type: string
  default: PluginSteps
- name: ModelDrivenAppsSolutionName
  type: string
  default: ModelDrivenApps

#  values:
#  - CP
#  - RP
#- name: solutionName
#  type: string
#  default: 
#  values:
#  - WebResources
#  - OptionSets
#  - Entities
#  - SecurityRoles
#  - Processes
#  - Plugins
#  - PluginSteps
#  - Dashboards
#  - ModelDrivenApps
  
trigger: none

pool:
  name: MOD Pool

variables:
- name: minor.version
  value: 0
- name: release.version
  value: 0 
- name: solution.prefix
  value: "RP"
- template: connectionStrings.yml

name: $(Build.DefinitionName) - $(Build.BuildId) 

stages: 
#----------------------------------Start Stage-------------------------------------------------------------------
  - stage: AssembleRelease
    jobs:
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Start Job~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - job: Assemble
      steps:
      - task: NuGetToolInstaller@1
        displayName: 'Use NuGet '

      - task: MSCRMToolInstaller@9
        displayName: 'MSCRM Tool Installer'

      - task: DeleteFiles@1
        displayName: 'Delete files from $(build.binariesdirectory)'
        inputs:
          SourceFolder: '$(build.binariesdirectory)'
          Contents: '**'

      - ${{ each parameter in parameters }}:
        - ${{ if contains(parameter.Key, 'SolutionName') }}:
          - template: assembleAndCheck.yml
            parameters:
              solutionName: ${{parameter.Value}}
              folderNames: CanvasApps,Other
              managed: Managed
              solutionprefix: $(solution.prefix)
              minorversion: $(minor.version)
              releaseversion: $(release.version)


      - publish: '$(build.binariesdirectory)/SystemTest'
        artifact: CumbriaBuild-Managed-RPRP

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Job~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#----------------------------------End Stage-------------------------------------------------------------------
#----------------------------------Start Stage-------------------------------------------------------------------

  - stage: ReleaseToTisskiPfPSystemTest
    dependsOn: AssembleRelease
    displayName: Release to Tisski PfP System Test
    jobs:
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Start Job~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - deployment: ReleaseToTisskiPfPSystemTest
      environment: PfPSysTestAzure
      displayName: Release To Tisski PfP SystemTest
      workspace:
        clean: all 
      strategy:
        runOnce:
          deploy:
            
            steps:
            
            - checkout: none
            - task: MSCRMToolInstaller@9
              displayName: 'MSCRM Tool Installer'
            
            - ${{ each parameter in parameters }}:
              - ${{ if contains(parameter.Key, 'SolutionName') }}:
                - template: deployBaseSolution.yml
                  parameters:
                    minorversion : $(minor.version)
                    releaseversion : $(release.version)
                    solutionprefix : $(solution.prefix)
                    solutionName: ${{parameter.Value}}
                    connectionString: $(pfpsystemtest.connection.string)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Job~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#----------------------------------End Stage-------------------------------------------------------------------

